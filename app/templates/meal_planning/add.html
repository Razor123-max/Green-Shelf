{% extends 'layout.html' %} {% block title %}Add Meal Plan - Green Shelf{%
endblock %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-plus-circle me-2"></i>Add Meal to Calendar</h2>
        <a
          href="{{ url_for('meal_planning.index') }}"
          class="btn btn-outline-secondary"
        >
          <i class="fas fa-arrow-left me-1"></i>Back to Calendar
        </a>
      </div>
    </div>
  </div>

  <form method="POST" id="mealPlanForm">
    {{ form.hidden_tag() }}

    <div class="row g-4">
      <!-- Left Column: Calendar and Meal Type Selection -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-calendar-alt me-2"></i>Select Date & Meal Type
            </h5>
          </div>
          <div class="card-body">
            <!-- Date Selection -->
            <div class="mb-4">
              <label for="date" class="form-label fw-bold">Date</label>
              <div class="input-group">
                {{ form.date(class="form-control", id="date") }}
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="todayBtn"
                >
                  Today
                </button>
              </div>
            </div>

            <!-- Meal Type Selection -->
            <div class="mb-4">
              <label class="form-label fw-bold">Meal Type</label>
              <div class="row g-2">
                <div class="col-6">
                  <input type="radio" class="btn-check" name="meal_type"
                  id="breakfast" value="breakfast" {% if form.meal_type.data ==
                  'breakfast' %}checked{% endif %}>
                  <label class="btn btn-outline-warning w-100" for="breakfast">
                    <i class="fas fa-coffee"></i><br />Breakfast
                  </label>
                </div>
                <div class="col-6">
                  <input type="radio" class="btn-check" name="meal_type"
                  id="lunch" value="lunch" {% if form.meal_type.data == 'lunch'
                  %}checked{% endif %}>
                  <label class="btn btn-outline-success w-100" for="lunch">
                    <i class="fas fa-utensils"></i><br />Lunch
                  </label>
                </div>
                <div class="col-6">
                  <input type="radio" class="btn-check" name="meal_type"
                  id="dinner" value="dinner" {% if form.meal_type.data ==
                  'dinner' %}checked{% endif %}>
                  <label class="btn btn-outline-primary w-100" for="dinner">
                    <i class="fas fa-moon"></i><br />Dinner
                  </label>
                </div>
                <div class="col-6">
                  <input type="radio" class="btn-check" name="meal_type"
                  id="snack" value="snack" {% if form.meal_type.data == 'snack'
                  %}checked{% endif %}>
                  <label class="btn btn-outline-info w-100" for="snack">
                    <i class="fas fa-cookie-bite"></i><br />Snack
                  </label>
                </div>
              </div>
            </div>

            <!-- Servings -->
            <div class="mb-3">
              <label for="servings" class="form-label fw-bold"
                >Number of Servings</label
              >
              {{ form.servings(class="form-control", id="servings", min="1",
              max="20") }}
            </div>
          </div>
        </div>

        <!-- Quick Calendar View -->
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-calendar me-2"></i>Quick Calendar
            </h6>
          </div>
          <div class="card-body">
            <div id="quickCalendar" class="calendar-grid">
              <!-- Calendar will be generated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Recipe Selection -->
      <div class="col-lg-6">
        <div class="card">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5 class="mb-0"><i class="fas fa-book me-2"></i>Select Recipe</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              id="refreshRecipes"
            >
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div class="card-body">
            <!-- Recipe Search -->
            <div class="mb-3">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="recipeSearch"
                  placeholder="Search recipes..."
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="searchBtn"
                >
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>

            <!-- Filter by Category -->
            <div class="mb-3">
              <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="snack">Snack</option>
                <option value="dessert">Dessert</option>
              </select>
            </div>

            <!-- Recipe Selection -->
            <div class="mb-3">
              <label class="form-label fw-bold">Choose Recipe</label>
              <div class="recipe-selection">
                {{ form.recipe_id(class="form-select", id="recipeSelect") }}
              </div>
            </div>

            <!-- Custom Meal Option -->
            <div class="mb-3">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="customMealToggle"
                />
                <label class="form-check-label" for="customMealToggle">
                  Or enter custom meal name
                </label>
              </div>
              <div id="customMealDiv" class="mt-2" style="display: none">
                {{ form.custom_meal_name(class="form-control",
                placeholder="Enter custom meal name...") }}
              </div>
            </div>

            <!-- Recipe Preview -->
            <div id="recipePreview" class="mt-3" style="display: none">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title" id="recipeName"></h6>
                  <div class="row">
                    <div class="col-6">
                      <small class="text-muted">Prep Time:</small>
                      <div id="prepTime">-</div>
                    </div>
                    <div class="col-6">
                      <small class="text-muted">Cook Time:</small>
                      <div id="cookTime">-</div>
                    </div>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">Serves:</small>
                    <span id="recipeServings">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Inventory Check -->
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-box me-2"></i>Inventory Check
              <span class="badge bg-secondary" id="inventoryStatus"
                >Select Recipe</span
              >
            </h6>
          </div>
          <div class="card-body">
            <div id="inventoryCheck">
              <p class="text-muted">
                Select a recipe to check ingredient availability
              </p>
            </div>

            <!-- Auto Order Section -->
            <div id="autoOrderSection" style="display: none">
              <hr />
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">Missing Ingredients</h6>
                  <small class="text-muted">Auto-order missing items?</small>
                </div>
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="autoOrderToggle"
                    {%
                    if
                    current_user.auto_order_enabled
                    %}checked{%
                    endif
                    %}
                  />
                  <label class="form-check-label" for="autoOrderToggle"
                    >Auto Order</label
                  >
                </div>
              </div>
              <div id="missingIngredients" class="mt-2">
                <!-- Missing ingredients will be listed here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="d-flex justify-content-end gap-2">
          <a
            href="{{ url_for('meal_planning.index') }}"
            class="btn btn-secondary"
          >
            <i class="fas fa-times me-1"></i>Cancel
          </a>
          <button type="submit" class="btn btn-success" id="submitBtn">
            <i class="fas fa-plus me-1"></i>Add Meal to Calendar
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    font-size: 0.8rem;
  }

  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .calendar-day:hover {
    background-color: #e9ecef;
  }

  .calendar-day.selected {
    background-color: #198754;
    color: white;
    border-color: #198754;
  }

  .calendar-day.other-month {
    color: #6c757d;
    background-color: #f8f9fa;
  }

  .calendar-day.today {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }

  .inventory-item {
    padding: 8px 12px;
    margin: 4px 0;
    border-radius: 6px;
    display: flex;
    justify-content: between;
    align-items: center;
  }

  .inventory-available {
    background-color: #d1edff;
    color: #0a58ca;
    border-left: 4px solid #0d6efd;
  }

  .inventory-low {
    background-color: #fff3cd;
    color: #664d03;
    border-left: 4px solid #ffc107;
  }

  .inventory-missing {
    background-color: #f8d7da;
    color: #721c24;
    border-left: 4px solid #dc3545;
  }

  .recipe-selection .form-select {
    min-height: 100px;
  }

  .btn-check:checked + .btn {
    transform: scale(1.05);
  }
</style>

<script>
  // Initialize calendar
  function initializeCalendar() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    generateCalendar(currentYear, currentMonth);

    // Set today as default if no date is selected
    const dateInput = document.getElementById("date");
    if (!dateInput.value) {
      dateInput.value = today.toISOString().split("T")[0];
    }
  }

  function generateCalendar(year, month) {
    const calendarGrid = document.getElementById("quickCalendar");
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    calendarGrid.innerHTML = "";

    // Add day headers
    const dayHeaders = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    dayHeaders.forEach((day) => {
      const dayHeader = document.createElement("div");
      dayHeader.textContent = day;
      dayHeader.className =
        "calendar-day-header text-center fw-bold small text-muted";
      calendarGrid.appendChild(dayHeader);
    });

    // Add calendar days
    for (let i = 0; i < 42; i++) {
      const currentDate = new Date(startDate);
      currentDate.setDate(startDate.getDate() + i);

      const dayElement = document.createElement("div");
      dayElement.className = "calendar-day";
      dayElement.textContent = currentDate.getDate();
      dayElement.dataset.date = currentDate.toISOString().split("T")[0];

      if (currentDate.getMonth() !== month) {
        dayElement.classList.add("other-month");
      }

      if (currentDate.toDateString() === new Date().toDateString()) {
        dayElement.classList.add("today");
      }

      dayElement.addEventListener("click", function () {
        document
          .querySelectorAll(".calendar-day")
          .forEach((d) => d.classList.remove("selected"));
        this.classList.add("selected");
        document.getElementById("date").value = this.dataset.date;
      });

      calendarGrid.appendChild(dayElement);
    }
  }

  // Recipe functionality
  function initializeRecipeSelection() {
    const recipeSelect = document.getElementById("recipeSelect");
    const customMealToggle = document.getElementById("customMealToggle");
    const customMealDiv = document.getElementById("customMealDiv");
    const recipePreview = document.getElementById("recipePreview");

    // Toggle custom meal input
    customMealToggle.addEventListener("change", function () {
      if (this.checked) {
        customMealDiv.style.display = "block";
        recipeSelect.disabled = true;
        recipePreview.style.display = "none";
        clearInventoryCheck();
      } else {
        customMealDiv.style.display = "none";
        recipeSelect.disabled = false;
        if (recipeSelect.value) {
          showRecipePreview(recipeSelect.value);
          checkInventory(recipeSelect.value);
        }
      }
    });

    // Recipe selection change
    recipeSelect.addEventListener("change", function () {
      if (this.value && !customMealToggle.checked) {
        showRecipePreview(this.value);
        checkInventory(this.value);
      } else {
        recipePreview.style.display = "none";
        clearInventoryCheck();
      }
    });

    // Recipe search
    const recipeSearch = document.getElementById("recipeSearch");
    const categoryFilter = document.getElementById("categoryFilter");

    recipeSearch.addEventListener("input", filterRecipes);
    categoryFilter.addEventListener("change", filterRecipes);
  }

  function showRecipePreview(recipeId) {
    // Fetch recipe details via AJAX
    fetch(`/recipes/${recipeId}/details`)
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("recipeName").textContent = data.name;
        document.getElementById("prepTime").textContent = data.prep_time
          ? `${data.prep_time} min`
          : "-";
        document.getElementById("cookTime").textContent = data.cook_time
          ? `${data.cook_time} min`
          : "-";
        document.getElementById("recipeServings").textContent =
          data.servings || "-";
        document.getElementById("recipePreview").style.display = "block";
      })
      .catch((error) => {
        console.error("Error fetching recipe details:", error);
      });
  }

  function checkInventory(recipeId) {
    if (!recipeId) return;

    const servings = document.getElementById("servings").value || 1;
    const inventoryStatus = document.getElementById("inventoryStatus");
    const inventoryCheck = document.getElementById("inventoryCheck");
    const autoOrderSection = document.getElementById("autoOrderSection");

    inventoryStatus.textContent = "Checking...";
    inventoryStatus.className = "badge bg-warning";

    fetch("/meal-planning/check-inventory", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document
          .querySelector('meta[name="csrf-token"]')
          .getAttribute("content"),
      },
      body: JSON.stringify({
        recipe_id: recipeId,
        servings: parseInt(servings),
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          inventoryStatus.textContent = "Error";
          inventoryStatus.className = "badge bg-danger";
          return;
        }

        let html = "";
        let missingItems = [];
        let allAvailable = true;

        data.ingredients.forEach((ingredient) => {
          let statusClass = "";
          let statusText = "";

          if (ingredient.status === "available") {
            statusClass = "inventory-available";
            statusText = `✓ Available (${ingredient.current_quantity} ${ingredient.unit})`;
          } else if (ingredient.status === "low") {
            statusClass = "inventory-low";
            statusText = `⚠ Low stock (${ingredient.current_quantity}/${ingredient.needed} ${ingredient.unit})`;
            allAvailable = false;
          } else {
            statusClass = "inventory-missing";
            statusText = `✗ Missing (need ${ingredient.needed} ${ingredient.unit})`;
            missingItems.push(ingredient);
            allAvailable = false;
          }

          html += `
                <div class="inventory-item ${statusClass}">
                    <div>
                        <strong>${ingredient.name}</strong>
                        <div class="small">${statusText}</div>
                    </div>
                </div>
            `;
        });

        inventoryCheck.innerHTML = html;

        if (allAvailable) {
          inventoryStatus.textContent = "All Available";
          inventoryStatus.className = "badge bg-success";
          autoOrderSection.style.display = "none";
        } else {
          inventoryStatus.textContent = `${missingItems.length} Missing`;
          inventoryStatus.className = "badge bg-warning";

          if (missingItems.length > 0) {
            showMissingIngredients(missingItems);
            autoOrderSection.style.display = "block";
          }
        }
      })
      .catch((error) => {
        console.error("Error checking inventory:", error);
        inventoryStatus.textContent = "Error";
        inventoryStatus.className = "badge bg-danger";
      });
  }

  function showMissingIngredients(missingItems) {
    const missingDiv = document.getElementById("missingIngredients");
    let html = '<div class="list-group list-group-flush">';

    missingItems.forEach((item) => {
      html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>${item.name}</strong>
                    <div class="small text-muted">Need ${item.needed} ${item.unit}</div>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="orderItem('${item.name}', ${item.needed}, '${item.unit}')">
                    <i class="fas fa-shopping-cart"></i> Order
                </button>
            </div>
        `;
    });

    html += "</div>";
    missingDiv.innerHTML = html;
  }

  function orderItem(itemName, quantity, unit) {
    if (!confirm(`Order ${quantity} ${unit} of ${itemName}?`)) return;

    fetch("/meal-planning/auto-order", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document
          .querySelector('meta[name="csrf-token"]')
          .getAttribute("content"),
      },
      body: JSON.stringify({
        item_name: itemName,
        quantity: quantity,
        unit: unit,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert(`${itemName} has been added to your cart!`);
        } else {
          alert(`Error: ${data.error}`);
        }
      })
      .catch((error) => {
        console.error("Error ordering item:", error);
        alert("Error placing order");
      });
  }

  function clearInventoryCheck() {
    document.getElementById("inventoryCheck").innerHTML =
      '<p class="text-muted">Select a recipe to check ingredient availability</p>';
    document.getElementById("inventoryStatus").textContent = "Select Recipe";
    document.getElementById("inventoryStatus").className = "badge bg-secondary";
    document.getElementById("autoOrderSection").style.display = "none";
  }

  function filterRecipes() {
    const searchTerm = document
      .getElementById("recipeSearch")
      .value.toLowerCase();
    const category = document.getElementById("categoryFilter").value;
    const select = document.getElementById("recipeSelect");

    Array.from(select.options).forEach((option) => {
      if (option.value === "") return; // Skip empty option

      const text = option.textContent.toLowerCase();
      const categoryMatch = !category || option.dataset.category === category;
      const searchMatch = text.includes(searchTerm);

      option.style.display = categoryMatch && searchMatch ? "block" : "none";
    });
  }

  // Initialize everything when page loads
  document.addEventListener("DOMContentLoaded", function () {
    initializeCalendar();
    initializeRecipeSelection();

    // Set today button functionality
    document.getElementById("todayBtn").addEventListener("click", function () {
      const today = new Date();
      document.getElementById("date").value = today.toISOString().split("T")[0];

      // Update calendar selection
      document
        .querySelectorAll(".calendar-day")
        .forEach((d) => d.classList.remove("selected"));
      const todayElement = document.querySelector(
        `.calendar-day[data-date="${today.toISOString().split("T")[0]}"]`
      );
      if (todayElement) {
        todayElement.classList.add("selected");
      }
    });

    // Update inventory check when servings change
    document.getElementById("servings").addEventListener("change", function () {
      const recipeSelect = document.getElementById("recipeSelect");
      if (
        recipeSelect.value &&
        !document.getElementById("customMealToggle").checked
      ) {
        checkInventory(recipeSelect.value);
      }
    });

    // Form submission
    document
      .getElementById("mealPlanForm")
      .addEventListener("submit", function (e) {
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin me-1"></i>Adding Meal...';
      });
  });
</script>
{% endblock %}
